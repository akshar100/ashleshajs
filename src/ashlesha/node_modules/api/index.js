var YUI = require('yui'), email = require('nodemailer'), Y, api={}, crypto = require('crypto'), cradle = require("cradle");

exports.setYInstance=function(c){
	Y = c;
};

var hash = function (pwd, salt){
  var shasum = crypto.createHash('sha1');
  shasum.update(pwd+salt);
  return shasum.digest('hex');
};
function login(config){
	
	
	return {
		success:true,
		user:{
			_id:"Someid",
			firstname:"Akshar",
			lastname:"Prabhu Desai",
			email:"akshar@akshar.co.in"
			
		}
	};
}
api.user ={
	is_taken:function(config){
		return {
			taken:false
		};
	},
	hash_password:function(config){
		var salt = "@PASSWORD_SALT@";
		return hash(config.val,salt);
	}
};

api.list = {
	timeline:function(config){
		return [{
			"id":"someide3",
			"author_name":"Akshar",
			"created_at":Date.now(),
			"posttext":"Hello wOrRLd",
			"comment_count":10
		}]
	}
};

api.db = {
	update:function(config,callback){
		var db,c;
		try{
		cradle.setup({
		    host: '@COUCHHOST@',
		    cache: true, 
		    raw: false
		});
		c = new(cradle.Connection);
		db = c.database('@COUCHDB_NAME@');
		db.save('_design/user', {
		    views: {
		      byEmail: {
		        map: 'function(doc){ if(doc.email){ emit(doc.email,doc); }}'
		      }
		    }
		 },function(err,data){
		 	Y.log(arguments);
		 	
		 });
		}catch(ex){
			Y.log(ex);
		}
		
	}	
};

exports.api = function(path,config,callback){
		var out;
		switch(path){
			
			case "/login":
				out = login(config);
				Y.fire("api:"+path,out);
				return out;
			case "/user/is_taken":
				return api.user.is_taken(config);
			case "/list/timeline":
				return api.list.timeline(config);
			case "/user/hash_password":
				return api.user.hash_password(config);
			case "/user/send_welcome_mail":
				return api.user.send_welcome_mail(config);
			case "/db/update":
				return api.db.update.apply(this,[config,callback]);
		}
	
}








var smtpTransport = email.createTransport("SMTP",{
    service: "Gmail",
    auth: {
        user: "akshar@akshar.co.in",
        pass: "inbullsx10.1"
    }
});

var mailOptions = {
    from: "Akshar Prabhu Desai <akshar@e-yantra.org>", // sender address
    to: "akshar@akskah.co.in", // list of receivers
    subject: "Hello ", // Subject line
    text: "Hello world ", // plaintext body
    html: "<b>Hello world </b>" // html body
}

function send_email(){
	smtpTransport.sendMail(mailOptions, function(error, response){
	    if(error){
	        console.log(error);
	    }else{
	        console.log("Message sent: " + response.message);
	    }
	
	    // if you don't want to use this transport object anymore, uncomment following line
	    smtpTransport.close(); // shut down the connection pool, no more messages
	});
}

